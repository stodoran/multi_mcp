name: Installation Tests

on:
  push:
    branches: [main]
    paths:
      - 'multi_mcp/**'
      - 'pyproject.toml'
      - 'Makefile'
      - 'scripts/install.sh'
      - '.github/workflows/install-test.yml'
  pull_request:
    branches: [main]
    paths:
      - 'multi_mcp/**'
      - 'pyproject.toml'
      - 'Makefile'
      - 'scripts/install.sh'
      - '.github/workflows/install-test.yml'
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      test_pypi:
        description: 'Test PyPI installation (requires package to be published)'
        required: false
        default: false
        type: boolean

jobs:
  # Test installation from git clone (pip install .)
  test-git-install:
    name: Git Install - ${{ matrix.os }} / Python ${{ matrix.python-version }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.11', '3.12', '3.13']

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install package from source
      run: |
        python -m pip install --upgrade pip
        pip install .

    - name: Verify entry points exist (Unix)
      if: runner.os != 'Windows'
      run: |
        which multi
        which multi-server
        which multi-mcp

    - name: Verify entry points exist (Windows)
      if: runner.os == 'Windows'
      run: |
        where multi
        where multi-server
        where multi-mcp
      shell: cmd

    - name: Test CLI commands
      run: |
        multi --help
        multi-server --help
        multi-mcp --help

    - name: Test Python import
      run: |
        python -c "import multi_mcp; print(f'multi_mcp imported successfully')"
        python -c "from multi_mcp.server import mcp; print(f'FastMCP server: {mcp}')"
        python -c "from multi_mcp.cli import main; print('CLI main imported')"

    - name: Test package metadata
      run: |
        python -c "import importlib.metadata; v = importlib.metadata.version('multi-mcp'); print(f'Version: {v}')"

  # Test make install (developer setup from git clone)
  test-make-install:
    name: Make Install - ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        # Skip Windows - install.sh is a bash script
        os: [ubuntu-latest, macos-latest]

    steps:
    - uses: actions/checkout@v4

    - name: Install uv
      uses: astral-sh/setup-uv@v4
      with:
        version: "latest"

    - name: Install Python 3.13
      run: uv python install 3.13

    - name: Run make install (non-interactive)
      run: |
        make install
      env:
        # CI=true triggers non-interactive mode in install.sh
        CI: true
        # Pin Python version (macOS has Python 3.14 which is unsupported)
        UV_PYTHON: "3.13"

    - name: Verify .venv was created
      run: |
        test -d .venv
        echo "✓ .venv directory exists"

    - name: Verify .env was created
      run: |
        test -f .env
        echo "✓ .env file exists"

    - name: Verify server module loads
      run: |
        .venv/bin/python -c "from multi_mcp.server import mcp; print(f'✓ Server module loads: {mcp}')"

    - name: Verify CLI entry points in venv
      run: |
        .venv/bin/python -m multi_mcp.cli --help
        .venv/bin/python -m multi_mcp.server --help

    - name: Run make verify
      run: |
        make verify

  # Test installation from PyPI (pip install multi-mcp)
  test-pypi-install:
    name: PyPI Install - ${{ matrix.os }} / Python ${{ matrix.python-version }}
    runs-on: ${{ matrix.os }}
    # Only run on release or manual trigger with test_pypi=true
    if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && inputs.test_pypi)
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.11', '3.12', '3.13']

    steps:
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install package from PyPI
      run: |
        python -m pip install --upgrade pip
        pip install multi-mcp

    - name: Verify entry points exist (Unix)
      if: runner.os != 'Windows'
      run: |
        which multi
        which multi-server
        which multi-mcp

    - name: Verify entry points exist (Windows)
      if: runner.os == 'Windows'
      run: |
        where multi
        where multi-server
        where multi-mcp
      shell: cmd

    - name: Test CLI commands
      run: |
        multi --help
        multi-server --help
        multi-mcp --help

    - name: Test Python import
      run: |
        python -c "import multi_mcp; print(f'multi_mcp imported successfully')"
        python -c "from multi_mcp.server import mcp; print(f'FastMCP server: {mcp}')"
        python -c "from multi_mcp.cli import main; print('CLI main imported')"

    - name: Test package metadata
      run: |
        python -c "import importlib.metadata; v = importlib.metadata.version('multi-mcp'); print(f'Version: {v}')"

  # Test installation with uvx (recommended method for Claude Code users)
  test-uvx-install:
    name: uvx Install - ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    # Only run on release or manual trigger with test_pypi=true
    if: github.event_name == 'release' || (github.event_name == 'workflow_dispatch' && inputs.test_pypi)
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
    - name: Install uv
      uses: astral-sh/setup-uv@v4
      with:
        version: "latest"

    - name: Test uvx multi-mcp
      run: |
        uvx multi-mcp --help

  # Summary job for branch protection
  install-test-summary:
    name: Installation Tests Summary
    runs-on: ubuntu-latest
    needs: [test-git-install, test-make-install]
    if: always()
    steps:
    - name: Check results
      run: |
        if [ "${{ needs.test-git-install.result }}" != "success" ]; then
          echo "Git install tests failed"
          exit 1
        fi
        if [ "${{ needs.test-make-install.result }}" != "success" ]; then
          echo "Make install tests failed"
          exit 1
        fi
        echo "All installation tests passed!"
