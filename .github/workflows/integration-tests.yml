name: Integration Tests

on:
  workflow_dispatch:
    inputs:
      test_path:
        description: 'Test path (default: tests/integration/)'
        required: false
        default: 'tests/integration/'
        type: string
      verbose:
        description: 'Enable verbose output'
        required: false
        default: true
        type: boolean

jobs:
  integration-test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install uv
      uses: astral-sh/setup-uv@v4
      with:
        version: "latest"
        enable-cache: true

    - name: Set up Python
      run: uv python install 3.13

    - name: Install dependencies with dev extras
      run: uv sync --frozen --extra dev

    - name: Run integration tests (parallel)
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        RUN_E2E: "1"
      run: |
        if [ "${{ inputs.verbose }}" = "true" ]; then
          uv run pytest ${{ inputs.test_path }} -n auto -vv --tb=short
        else
          uv run pytest ${{ inputs.test_path }} -n auto
        fi

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: integration-test-results
        path: |
          logs/
          htmlcov/
        retention-days: 7
